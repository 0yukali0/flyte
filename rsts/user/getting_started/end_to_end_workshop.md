Workshop docs
=============

Welcome to Flyte 101 workshop. After completing this workshop, you will be able to:
- Start a completely new Flyte Project & Repo
- Add new and Modify existing tasks and workflows
- Write hive, python and sagemaker tasks
- Register and launch tasks and workflows
- [Not Yet] Access the outputs generated by workflows in Mode

> **NOTE**
>
>[Official Documentation](https://docs.lyft.net/eng/flyte/index.html) is your friend. Please consult with it before posting questions to [#flyte](https://join.slack.com/share/zt-ilb4zzrb-ZU5aOiQgJBLYXwrv21G_sg)

-------------------------------
## Step 1 Install flytekit (5 mins)

Flytekit is the python SDK you will use to write and interact with flyte. It includes a few tools to help you build, test, register and run your workflows and tasks.

To start, itâ€™s recommended that you create a python virtual environment. Then install flytekit into it.

<details>
  <summary>Click to show the solution!</summary>

  ```
  mkvirtualenv --python=python3 flyte-101
  pip install flytekit
  flyte-cli setup-config --host flyte.lyft.net
  ```
</details>

------------------------------

## Step 2 Create a project (5 mins)

Flyte projects are logical units to help you organize your tasks and workflows. A single repo can have multiple projects and many repos can contribute to the same project.

The typical setup we have seen is that people create a single project per repo.

```flyte-cli``` is the user-facing command line tool that comes with flytekit to interact with the flyte system.

Create a _personal_ project (e.g. john-flyte-workshop). Provisioning the project for the first time can take up to 2 minutes (it runs on a cron job).

<details>
  <summary>Click to show the solution!</summary>

  ```
  flyte-cli register-project --name "Jon's Workshop" --identifier flyte-workshop-john --descriptoin "My workshop solution"
  ```
</details>

-----------------------------

## Step 3 Clone Playground repo (5 mins)

A typical setup for a new flyte project involves creating a new repo (using metaservice) and applying the flyteworkflow yeoman generator.

Find the [full guidance exist here](https://docs.lyft.net/eng/flyte/flyte2/user/getting_started_at_lyft/setting_up.html).

For the purposes of this workshop, we will clone github.com/lyft/flyteplayground since it's already setup with everything you need.
Go ahead and clone branch `workshop-exercise` from that repo! and while you are at it, rename [this](https://github.com/lyft/flyteplayground/blob/4f6133e996e42c8c7a429993d9f225af7d59d57a/Makefile#L65) and [this](https://github.com/lyft/flyteplayground/blob/4f6133e996e42c8c7a429993d9f225af7d59d57a/Makefile#L10) to the name of the project you created above.

<details>
  <summary>Click to show the solution!</summary>

  ```
  git clone --branch workshop-exercise git@github.com:lyft/flyteplayground
  cd flyteplayground
  ```
</details>

-----------------------------

## Step 4 Make sure it works! (10 mins)

At this point your repo is ready to be used. To double check things are working fine. In order not to interfere with others doing the same exercise, please create your own branch then you can create a PR with the changes you just made and monitor the PR Checks to make sure everything is green.

<details>
  <summary>Click to show the solution!</summary>

  ```
  git checkout -b "my-branch-101"
  git add -A
  git commit -m "My first Flyte Workflow"
  git push
  echo "Visit the URL in the logs to create the PR. Do not merge it."
  ```
</details>

-----------------------------

## Step 5 Launch an existing Task/Workflow from the UI (5 mins)

After all PR checks succeed, your workflows should be registered into your project.
If you visit the main [flyte console](https://flyte.lyft.net/console) and search for your project, you should see all registered workflows and tasks under the appropriate tab.

Go ahead and click on `workflows.simple_workflow.SimpleWorkflow` and click `Launch` on the top right corner.

-----------------------------

## Step 6 Train a model on Flyte! (35 mins)

Flyte is an orchestration platform. It has the capability to schedule and run a magnitude of compute tasks (from simple Python tasks, to native mapping tasks to external services like Hive, Presto, SageMaker and many more).

For this exercise, you will leverage the ability to run Hive queries and SageMaker's built-in XGBoost Training tasks. You will then run batch predict on the generated model using a subset of the data you acquired.

The goal of the model is to predict the number of rides per hour for a given time period.

### Tasks
Using your favorite IDE, navigate to `workflows/workshop.py` to view the workflow we will be filling in.

In that file, we've written out a skeleton of the workflow we will be writing. And some helper functions you might need.

Navigate around and start filling in the commented blocks.

<details>
  <summary>Code-block 1 Solution (10 mins)</summary>

  ```
  airport_requests = SdkPrestoTask(
      task_inputs=inputs(start=Types.Datetime, end=Types.Datetime, city=Types.String),
      statement="""SELECT date_trunc('hour',requested_at) as time
                        ,COUNT() as requests
                  FROM city.fact_airport_rides
                  WHERE ds between '{{ .Inputs.start }}' and '{{ .Inputs.end }}'
                    AND airport_code='{{ .Inputs.city }}'
                  GROUP BY 1
                  ORDER BY 1""",
      output_schema=schema,
      routing_group="adhoc",
      catalog="hive",
      schema="city",
      discoverable=True,
      discovery_version="1.0"
  )
  ```
</details>

<details>
  <summary>Code-block 3 Solution (5 mins)</summary>

  ```
  # Train, Validation, Test
  SPLIT_RATIOS = [0.6, 0.3, 0.1]

  train_test_split_task = SdkTask.fetch(project="flyteplayground", domain="development",
                                        name="workflows.workshop.train_test_split_task",
                                        version="239ad82130e8d556f7480055b71feaad37d8d08a")
  ```
</details>

<details>
  <summary>Code-block 4 Solution (10 mins)</summary>

  ```
  # Defining the values of some hyperparameters, which will be used by the TrainingJob
  # these hyper-parameters are commonly used by the XGboost algorithm. Here we bootstrap them with some default Values
  # Usually the default values are selected or "tuned - refer to next section"
  xgboost_hyperparameters = {
      "num_round": "100",
      "base_score": "0.5",
      "booster": "gbtree",
      "csv_weights": "0",
      "dsplit": "row",
      "grow_policy": "depthwise",
      "lambda_bias": "0.0",
      "max_bin": "256",
      "normalize_type": "tree",
      "objective": "reg:linear",
      "one_drop": "0",
      # "prob_buffer_row": "1.0",
      "process_type": "default",
      "refresh_leaf": "1",
      "sample_type": "uniform",
      "scale_pos_weight": "1.0",
      "silent": "0",
      "skip_drop": "0.0",
      "tree_method": "auto",
      "tweedie_variance_power": "1.5",
      "updater": "grow_colmaker,prune",
  }

  # Here we define the actual algorithm (XGBOOST) and version of the algorithm to use
  alg_spec = training_job_models.AlgorithmSpecification(
      input_mode=training_job_models.InputMode.FILE,
      algorithm_name=training_job_models.AlgorithmName.XGBOOST,
      algorithm_version="0.90",
      input_content_type=training_job_models.InputContentType.TEXT_CSV,
  )

  # Finally lets use Flytekit plugin called SdkBuiltinAlgorithmTrainingJobTask, to create a task that wraps the algorithm.
  # This task does not really have a user-defined function as the actual algorithm is pre-defined in Sagemaker.
  # But, this task still has the same set of properties like any other FlyteTask
  # - Caching
  # - Resource specification
  # - versioning etc
  xgboost_train_task = built_in_training_job_task.SdkBuiltinAlgorithmTrainingJobTask(
      training_job_resource_config=training_job_models.TrainingJobResourceConfig(
          instance_type="ml.m4.xlarge",
          instance_count=1,
          volume_size_in_gb=25,
      ),
      algorithm_specification=alg_spec,
      cache_version='blah9',
      cacheable=True,
  )
  ```
</details>

<details>
  <summary>Code-block 5 Solution (10 mins)</summary>

  ```
  @workflow_class
  class RideCountPredictor(object):
      start_time = Input(Types.Datetime, default=datetime(year=2020, month=10, day=1, tzinfo=pytz.utc))
      end_time = Input(Types.Datetime, default=datetime(year=2020, month=10, day=10, tzinfo=pytz.utc))
      city = Input(Types.String, default='LAX', help="Enter city or region to train on")
      seed = Input(Types.Integer, default=8, help="Seed to use for data splitting")
      data_task = airport_requests(start=start_time, end=end_time, city=city)
      train_test_split_data = train_test_split_task(input_data=data_task.outputs.results, seed=seed, split=SPLIT_RATIOS)
      train_data = transform_parquet_to_csv(input_parquet=train_test_split_data.outputs.train)
      validation_data = transform_parquet_to_csv(input_parquet=train_test_split_data.outputs.validation)
      test_data = transform_parquet_to_csv(input_parquet=train_test_split_data.outputs.test)
      model_task = xgboost_train_task(train=train_data.outputs.output_csv,
                                      validation=validation_data.outputs.output_csv,
                                      static_hyperparameters=xgboost_hyperparameters)

      model = Output(model_task.outputs.model, sdk_type=Types.Blob)
  ```
</details>

### Bonus 1
Write a predict function that uses the test dataset produced by the split task and run it through the model to compute accuracy.

Remember that, at least for the time being, you will need to create a PR with the function code in order to be able to run it as a task. This requirement will be lifted once Fast Registration ships.

### Bonus 2
Write unit tests for the new predict function.

Unit tests for flyte tasks allow you to validate your changes before going through the, sometimes lengthy, process of creating and waiting for a PR. They can save you valuable time and allow you to iterate on your code much faster!

-----------------------------

When you are done, compare what you have with this:
[Complete Solution](https://github.com/lyft/flyteplayground/blob/workshop/workflows/workshop.py)

-----------------------------

## Where do we go from here

Flyte is always evolving, subscribe to [flyte@](https://groups.google.com/a/lyft.com/g/flyte) google group to hear the latest about the product.

Read [the docs](https://docs.lyft.net/eng/flyte/index.html). We are constantly improving documentation and adding examples.

We would love to hear from you! Please reach out to [#flyte](https://join.slack.com/share/zt-ilb4zzrb-ZU5aOiQgJBLYXwrv21G_sg) Slack Channel if you have any questions or problems writing your workflows.
